# U_Net
My notes for U-Net.

- [Install packages by conda installation](#install-packages-by-conda-installation)
- [Issue](#issue)
- [Usage](#usage)
  - [Training](#training)
  - [Prediction](#prediction) 
- [Reference](#reference)
## Get started (Anaconda environment)
- Install the packages step by step using the commands below.
  - Pytorch (with CUDA wheel), this command was generated by [Pytorch install page](https://pytorch.org/get-started/locally/)
    ```bash
    pip3 install torch torchvision --index-url https://download.pytorch.org/whl/cu130
    ```
  - Other
    ```bash
    conda install conda-forge::wandb
    conda install conda-forge::tqdm
    conda install conda-forge::matplotlib
    ```
- Env file: *environment.yaml*
- Pkg list file: *requirement.txt*

## Issue
### Pydantic 2.12+, `Field()` , `UNSUPPORTED_STANDALONE_FIELDINFO_ATTRIBUTES` warning
- Issue description
  ```bash
  pydantic.warnings.UnsupportedFieldAttributeWarning: The 'repr' attribute with value False was provided to the `Field()` function, which has no effect in the context it was used. 'repr' is field-specific metadata, and can only be attached to a model field using `Annotated` metadata or by assignment. This may have happened because an `Annotated` type alias using the `type` statement was used, or if the `Field()` function was attached to a single member of a union type.
  ```
- Root cause  
  The issue in `wandb/_pydantic/field_types.py` line 16 and 20:
  ```python
  Typename = Annotated[T, Field(repr=False, frozen=True, alias="__typename")]
  GQLId = Annotated[StrictStr, Field(repr=False, frozen=True)]
  ```
  In Pydantic 2.12, `repr` and `frozen` parameters have no effect when used in `Annotated` type aliases that are later combined with another `Field()` call in model definitions. These parameters are listed in Pydantic's `UNSUPPORTED_STANDALONE_FIELDINFO_ATTRIBUTTES`.
- Proposed fix
  Remove the ineffective parameters from the type aliases:
  ```python
  Typename = Annotated[T, Field(alias="__typename")]
  ```
  ```python
  GQLId = Annotated[StrictStr, Field()]
  ```
  This changes has no behavioralimpact since these parameters were already being ignored by Pydantic, but it eliminates the warning.

### Method is deprecated
`torch.cuda.amp.GradScaler(args...)` is deprecated.
```python
# Change
grad_scaler = torch.cuda.amp.GradScaler(enabled=amp)
# To
grad_scaler = torch.amp.GradScaler('cuda', enabled=amp)
```

### 虛擬記憶體不足
- 建議**虛擬記憶體**的起始大小和最大值可以設定成RAM的1倍和2.5倍
- 舉例 : 電腦的RAM 是 16 GB (1 GB = 1024 MB), 那起始大小就設 16384 MB, 最大值則設 40960 MB

## Usage
### Training
- By default, the `scale` is **0.5**, so if you wish to obtain better results, set it to **1**. ( but use more memory )
  ![Train command](./images/train_command.png)

### Prediction
- You can specify which model file to use with `--model MODEL.pth`.
- To predict a single image and save it
  ```bash
  python predict.py -i image.jpg -o output.jpg
  ```
  ![Predict command](./images/predict_command.png)
  

## Reference
- [Github: milesial Pytorch-UNet](https://github.com/milesial/Pytorch-UNet)
- [Pytorch Model Hub: U-Net for brain MRI](https://pytorch.org/hub/mateuszbuda_brain-segmentation-pytorch_unet/)
